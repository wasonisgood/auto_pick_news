# .github/workflows/daily-news-analysis.yml
name: æ¯æ—¥æ—¥æœ¬æ–°èåˆ†æ

on:
  # æ¯å¤© UTC 18:00 åŸ·è¡Œï¼ˆæ—¥æœ¬æ™‚é–“å‡Œæ™¨ 3:00ï¼‰
  schedule:
    - cron: '0 18 * * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      target_date:
        description: 'æŒ‡å®šåˆ†ææ—¥æœŸ (YYYYMMDDï¼Œå¯é¸)'
        required: false
        type: string

jobs:
  trigger-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“… è¨­å®šæ™‚å€å’Œæ™‚é–“
      run: |
        echo "UTC æ™‚é–“: $(date -u)"
        echo "æ—¥æœ¬æ™‚é–“ (JST): $(TZ='Asia/Tokyo' date)"
        echo "åŸ·è¡Œæ™‚é–“: æ—¥æœ¬æ™‚é–“æ¯æ—¥å‡Œæ™¨ 3:00"
    
    - name: ğŸš€ è§¸ç™¼ Netlify Function
      run: |
        echo "æ­£åœ¨è§¸ç™¼æ–°èåˆ†æ..."
        
        # è¨­å®šç›®æ¨™æ—¥æœŸï¼ˆå¦‚æœæ‰‹å‹•æŒ‡å®šï¼‰
        if [ -n "${{ github.event.inputs.target_date }}" ]; then
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          echo "ä½¿ç”¨æ‰‹å‹•æŒ‡å®šæ—¥æœŸ: $TARGET_DATE"
        else
          # è‡ªå‹•è¨ˆç®—æ—¥æœ¬æ™‚é–“çš„å‰ä¸€å¤©
          TARGET_DATE=$(TZ='Asia/Tokyo' date -d '1 day ago' '+%Y%m%d')
          echo "è‡ªå‹•è¨ˆç®—ç›®æ¨™æ—¥æœŸ: $TARGET_DATE"
        fi
        
        # å‘¼å« Netlify Function
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d "{\"target_date\": \"$TARGET_DATE\"}" \
          "${{ secrets.NETLIFY_FUNCTION_URL }}")
        
        # åˆ†é›¢å›æ‡‰å…§å®¹å’Œç‹€æ…‹ç¢¼
        HTTP_BODY=$(echo "$RESPONSE" | sed -n '1,/HTTP_STATUS:/p' | head -n -1)
        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
        
        echo "HTTP ç‹€æ…‹ç¢¼: $HTTP_STATUS"
        echo "å›æ‡‰å…§å®¹:"
        echo "$HTTP_BODY" | jq '.' || echo "$HTTP_BODY"
        
        # æª¢æŸ¥åŸ·è¡Œçµæœ
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "âœ… æ–°èåˆ†æåŸ·è¡ŒæˆåŠŸ"
          
          # æå–é—œéµè³‡è¨Š
          SUCCESS=$(echo "$HTTP_BODY" | jq -r '.success // false')
          SAVED_COUNT=$(echo "$HTTP_BODY" | jq -r '.data.saved_count // 0')
          MESSAGE=$(echo "$HTTP_BODY" | jq -r '.message // "ç„¡è¨Šæ¯"')
          
          echo "åŸ·è¡Œçµæœ: $SUCCESS"
          echo "å„²å­˜æ•¸é‡: $SAVED_COUNT"
          echo "è¨Šæ¯: $MESSAGE"
          
          # å¦‚æœæœ‰éŒ¯èª¤ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          ERRORS=$(echo "$HTTP_BODY" | jq -r '.errors // empty')
          if [ -n "$ERRORS" ] && [ "$ERRORS" != "null" ]; then
            echo "âš ï¸ åŸ·è¡Œéç¨‹ä¸­çš„éŒ¯èª¤:"
            echo "$ERRORS" | jq -r '.[]'
          fi
          
        else
          echo "âŒ æ–°èåˆ†æåŸ·è¡Œå¤±æ•—"
          echo "ç‹€æ…‹ç¢¼: $HTTP_STATUS"
          echo "éŒ¯èª¤å…§å®¹: $HTTP_BODY"
          exit 1
        fi
    
    - name: ğŸ“Š ç™¼é€åŸ·è¡Œçµæœé€šçŸ¥ (å¯é¸)
      if: always()
      run: |
        echo "å¯ä»¥åœ¨é€™è£¡åŠ å…¥é€šçŸ¥é‚è¼¯"
        echo "ä¾‹å¦‚ï¼šç™¼é€åˆ° Slackã€Discordã€Email ç­‰"
        echo "æˆ–è€…æ›´æ–°ç‹€æ…‹åˆ°å…¶ä»–æœå‹™"
        
        # ç¯„ä¾‹ï¼šç™¼é€ç°¡å–®çš„ webhook é€šçŸ¥
        # curl -X POST "${{ secrets.WEBHOOK_URL }}" \
        #   -H "Content-Type: application/json" \
        #   -d "{\"text\": \"æ—¥æœ¬æ–°èåˆ†æå®Œæˆ: $(date)\"}"

  # å‚™ç”¨ jobï¼šæª¢æŸ¥åŸ·è¡Œæ­·å²
  check-history:
    runs-on: ubuntu-latest
    needs: trigger-analysis
    if: always()
    
    steps:
    - name: ğŸ“ˆ æª¢æŸ¥æœ€è¿‘åŸ·è¡Œæ­·å²
      run: |
        echo "=== æœ€è¿‘çš„åŸ·è¡Œè¨˜éŒ„ ==="
        echo "æœ¬æ¬¡åŸ·è¡Œæ™‚é–“: $(date -u)"
        echo "ä¸‹æ¬¡é å®šåŸ·è¡Œ: æ˜å¤© UTC 18:00 (æ—¥æœ¬æ™‚é–“å‡Œæ™¨ 3:00)"
        
        # å¯ä»¥åŠ å…¥æŸ¥è©¢è³‡æ–™åº«çš„é‚è¼¯ä¾†æª¢æŸ¥æœ€è¿‘çš„åŸ·è¡Œè¨˜éŒ„
        echo "å¦‚éœ€æª¢æŸ¥è©³ç´°åŸ·è¡Œæ­·å²ï¼Œè«‹æŸ¥çœ‹ Supabase è³‡æ–™åº«ä¸­çš„ selected_news è¡¨æ ¼"